var dbmanager = require('./dbmanager');
var mongodb = require('mongodb');
var conf = require('./config');
var mkdirp = require('mkdirp');

// Create directory
mkdirp('data', function(err) {
   if (err) throw err;
});

// Create DB collections and indexes
dbmanager.init(conf.bd);
dbmanager.connect(function(err, con) {

   console.log("Connected to database");

   dbmanager.db.createCollection(conf.bd.HOT_SPOTS, function(err, col) {
      if (err) throw err;
      console.log(" - created " + conf.bd.HOT_SPOTS);

      var name = col.collectionName;
      dbmanager.db.ensureIndex(name,{"coordinates":"2dsphere"}, create_fires);
      
      console.log("Index created on " + col.collectionName);
   });
});


var create_fires = function(){
   dbmanager.db.createCollection(conf.bd.FIRES, function(err, col) {
      if (err) throw err;
      console.log(" - created " + conf.bd.FIRES);

      var name = col.collectionName;
      dbmanager.db.ensureIndex(conf.bd.FIRES,{"coordinates":"2dsphere"}, close_conection);

      console.log("Index created on " + col.collectionName);
   });
}

var close_conection = function(){
   dbmanager.disconnect(process.kill);
}
